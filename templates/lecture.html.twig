{% extends 'base.html.twig' %}

{% block title %}{{ courseName }}: {{ type }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/lecture.css') }}">
{% endblock %}

{#{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('js/lecture.js') }}"></script>
{% endblock %}#}

{% block content %}
    <div class="container">
        <h1>{{ courseName }}: {{ type }}</h1>

        {% if type == 'Lecture' %}
            <div class="section ratings-section">
                <h2 class="section-title">Difficulty Rating of Past Exam</h2>
                <div class="card">
                    <div class="card-body">
                        {% if averageCourseRating %}
                            <p class="card-text">Exam Difficulty: {{ averageCourseRating.average|number_format(2) }}</p>
                            <p class="card-text">Number of People who voted: {{ averageCourseRating.count }}</p>
                        {% else %}
                            <p class="card-text">No ratings available.</p>
                        {% endif %}
                        <a href="{{ path('rate_this_exam', {'courseId': course.id, 'type': type}) }}" class="btn btn-primary">Rate this Exam</a>
                    </div>
                </div>
            </div>

            <div class="section ratings-section">
                <h2 class="section-title">Rating for Professor</h2>
                <div class="card">
                    <div class="card-body">
                        {% if averageProfessorRating %}
                            <h5 class="card-title">Professor Name: {{ professorName }}</h5>
                            <p class="card-text">Average Rating: {{ averageProfessorRating.average|number_format(2) }}</p>
                            <p class="card-text">Number of Ratings: {{ averageProfessorRating.count }}</p>
                        {% else %}
                            <p class="card-text">No ratings available.</p>
                        {% endif %}
                        <a href="{{ path('rate_professor', {'professorId': professor.id, 'type': type, 'courseId': course.id}) }}" class="btn btn-primary">Rate this Professor</a>
                    </div>
                </div>
            </div>

        {% elseif type == 'Lab' %}
            <div class="section ratings-section">
                <h2 class="section-title">Difficulty Rating of Past Lab</h2>
                <div class="card">
                    <div class="card-body">
                        {% if averageLabRating %}
                            <p class="card-text">Lab Difficulty: {{ averageLabRating.average|number_format(2) }}</p>
                            <p class="card-text">Number of People who voted: {{ averageLabRating.count }}</p>
                        {% else %}
                            <p class="card-text">No ratings available.</p>
                        {% endif %}
                        <a href="{{ path('rate_lab', {'courseId': course.id, 'type': type}) }}" class="btn btn-primary">Rate this Lab</a>
                    </div>
                </div>
            </div>

            <div class="section ratings-section">
                <h2 class="section-title">Rating for Lab Instructor</h2>
                {% for labInstructorRating in labInstructorRatings %}
                    <div class="lab-instructor-wrapper">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Lab Instructor Name: {{ labInstructorRating.labInstructor.name }}</h5>
                                {% if labInstructorRating.averageRating.average %}
                                    <p class="card-text">Average Rating: {{ labInstructorRating.averageRating.average|number_format(2) }}</p>
                                    <p class="card-text">Number of Ratings: {{ labInstructorRating.averageRating.count }}</p>
                                {% else %}
                                    <p class="card-text">No ratings available.</p>
                                {% endif %}
                                <a href="{{ path('rate_lab_instructor', {'labInstructorId': labInstructorRating.labInstructor.id, 'type': type, 'courseId': course.id}) }}" class="btn btn-primary">Rate this Lab Instructor</a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <div class="section materials-section">
            <h2 class="section-title">Materials</h2>
            {% for material in studyMaterials %}
                {% if material.getFilePath() %}
                    <div class="pdf-link">
                        {% set pdf_parts = material.getFilePath() | split('/') %}
                        <a href="{{ material.getFilePath() }}" target="_blank" rel="noopener noreferrer">
                            {{ pdf_parts | last }}
                        </a>
                    </div>
                {% elseif material.getTestPdf() %}
                    <div class="pdf-link">
                        <a href="{{ path('view_pdf', {id: material.getId()}) }}" target="_blank" rel="noopener noreferrer">
                            {{ material.getText() }}
                        </a>
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <div class="section upload-section">
            <h2 class="section-title">Upload your file here</h2>
            <div class="upload-wrapper">
                {{ form_start(form) }}
                {{ form_row(form.course) }}
                {{ form_row(form.type) }}
                {{ form_row(form.text) }}
                {{ form_row(form.test_pdf) }}
                <button class="btn btn-primary">Upload</button>
                {{ form_end(form) }}
            </div>
        </div>
        <div class="section comments-section">
            <h2 class="section-title">Comments</h2>
            {#this is where the user will post their own comment#}
            <div class="comment-form">
                {{ form_start(commentForm) }}
                {{ form_widget(commentForm) }}
                <button type="submit" class="btn btn-primary">Add Comment</button>
                {{ form_end(commentForm) }}
            </div>
            {# below this all the comments for this page will be displayed#}
            <div class="comment-list">
                {% for comment in comments %}
                    {% if comment.getParent() is null %}
                        <div class="comment-wrapper">  <!-- Added wrapper for each top-level comment -->
                            <div class="comment">
                                <p>{{ comment.getCommentText() }}</p>
                                <small>Posted by User {{ comment.getUserId() }} on {{ comment.getCreatedAt()|date('Y-m-d H:i') }}</small>
                                <button class="reply-button" data-comment-id="{{ comment.getId() }}">Reply</button>
                            </div>
                            <!-- Reply Form (Hidden by default) -->
                            <div class="reply-form" id="reply-form-{{ comment.id }}" style="display: none;">
                                {{ form_start(replyForms[comment.id], {'attr': {'class': 'reply-form'}}) }}
                                {{ form_widget(replyForms[comment.id]) }}
                                <input type="hidden" name="reply_form[parent_id]" value="{{ comment.id }}">
                                <button type="submit" class="btn btn-primary">Submit</button>
                                {{ form_end(replyForms[comment.id]) }}
                            </div>
                            {% if comment.getChildren() is not empty %}
                                <div class="replies">
                                    {% for child in comment.getChildren() %}
                                        <div class="comment-wrapper">  <!-- Added wrapper for each child comment -->
                                            <div class="comment">
                                                <p>{{ child.getCommentText() }}</p>
                                                <small>Posted by User {{ child.getUserId() }} on {{ child.getCreatedAt()|date('Y-m-d H:i') }}</small>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        {#    template for a reply form that is intially hidden#}
        {#<div id="reply-form-template" style="display: none;">
            {{ form_start(replyForm) }}
            {{ form_widget(replyForm.comment_text) }}
            {{ form_widget(replyForm._token) }} #}{# Render the CSRF token #}{#
            <input type="hidden" name="parent_id" class="parent_id">
            <button type="submit" class="btn btn-primary">Reply</button>
            {{ form_end(replyForm) }}
        </div>#}
    </div>
{% endblock %}

{#
{% block javascripts %}
    {{ parent() }}
    {% for js in javascripts %}
        <script src="{{ asset('js/' ~ js) }}"></script>
        <script src="{{ asset('js/lecture.js') }}"></script>
    {% endfor %}
{% endblock %}#}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            console.log("DOM fully loaded and parsed");

            // Add event listeners to all reply buttons
            document.querySelectorAll('.reply-button').forEach(button => {
                console.log("Attaching event listener to reply button", button);
                button.addEventListener('click', event => {
                    console.log("Reply button clicked"); // Log when the reply button is clicked
                    const commentId = event.target.getAttribute('data-comment-id');
                    const replyForm = document.getElementById(`reply-form-${commentId}`);
                    console.log("Reply form element:", replyForm);
                    // Toggle visibility of the reply form
                    if (replyForm.style.display === 'none' || replyForm.style.display === '') {
                        replyForm.style.display = 'block';
                    } else {
                        replyForm.style.display = 'none';
                    }
                    // Set the parent_id hidden field value
                    const parentIdField = replyForm.querySelector('input[name="reply_form[parent_id]"]');
                    if (parentIdField) {
                        parentIdField.value = commentId;
                    }
                });
            });
        });

    </script>
{% endblock %}


